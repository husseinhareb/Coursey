<!-- Show spinner / error for the course itself -->
<div *ngIf="loadingCourse">Loading course‚Ä¶</div>
<div *ngIf="courseError" class="error">{{ courseError }}</div>

<div *ngIf="course">
  <h2>{{ course.title }}</h2>
  <p>{{ course.description }}</p>
</div>

<hr />

<!-- Add / Edit Post Form Toggle -->
<button (click)="toggleForm()">
  {{ editing ? 'Edit Post' : '+ Add Post' }}
</button>

<!-- The form to create or update a post -->
<div *ngIf="showForm" class="post-form">
  <form [formGroup]="postForm" (ngSubmit)="savePost()">
    <div>
      <label>Title:</label>
      <input formControlName="title" placeholder="Title" />
    </div>
    <div>
      <label>Content:</label>
      <textarea formControlName="content" placeholder="Content"></textarea>
    </div>
    <div>
      <label>Type:</label>
      <select formControlName="type">
        <option value="lecture">Lecture</option>
        <option value="reminder">Reminder</option>
        <option value="homework">Homework</option>
      </select>
    </div>
    <div *ngIf="postForm.get('type')?.value === 'lecture' || postForm.get('type')?.value === 'homework'">
      <label>Attach File (optional):</label>
      <input type="file" (change)="onFileSelected($event)" />
    </div>
    <div>
      <button type="submit" [disabled]="postForm.invalid">
        {{ editing ? 'Update' : 'Create' }}
      </button>
      <button type="button" (click)="toggleForm()">Cancel</button>
    </div>
  </form>
</div>

<hr />

<!-- Show loading / error for posts -->
<div *ngIf="loadingPosts">Loading posts‚Ä¶</div>
<div *ngIf="postsError" class="error">{{ postsError }}</div>

<!-- Posts List -->
<ul *ngIf="!loadingPosts && !postsError" class="posts-list">
  <li *ngFor="let p of posts" class="post-item">
    <h3>
      {{ p.ispinned ? 'üìå ' : '' }}{{ p.title }}
      <span *ngIf="p.type === 'homework'" style="color: green;">(HW)</span>
    </h3>
    <p>{{ p.content }}</p>
    <small>Type: {{ p.type }}</small>
    <br />
    <small>Position: {{ p.position }}</small>
    <br />
    <small *ngIf="p.ispinned">
      Pinned At: {{ p.pinnedAt | date: 'short' }}
    </small>
    <br />

    <!-- Pin / Unpin Button -->
    <button (click)="togglePin(p)">
      {{ p.ispinned ? 'Unpin' : 'Pin' }}
    </button>

    <!-- ‚ñ≤ / ‚ñº arrows for non-pinned posts only -->
    <button
      *ngIf="!p.ispinned"
      (click)="moveUp(p)"
      [disabled]="p.position === 1"
      title="Move up"
    >
      ‚ñ≤
    </button>
    <button
      *ngIf="!p.ispinned"
      (click)="moveDown(p)"
      [disabled]="p.position === unpinnedCount"
      title="Move down"
    >
      ‚ñº
    </button>

    <!-- Edit / Delete Buttons -->
    <button (click)="toggleForm(p)">Edit</button>
    <button (click)="deletePost(p)">Delete</button>

    <!-- HOMEWORK-SPECIFIC ACTIONS: Show only if type === 'homework' -->
    <div *ngIf="p.type === 'homework'" class="homework-actions">
      <br />
      <strong>Homework Actions:</strong>
      <br />
      
      <!-- Submit Homework Button (for students) -->
      <button (click)="toggleSubmissionForm(p._id)" class="submit-btn">
        {{ showSubmissionFormForPostId === p._id ? 'Cancel Submit' : 'Submit Homework' }}
      </button>
      
      <!-- View Submissions Button (for teachers/admins) -->
      <button (click)="toggleSubmissionList(p._id)" class="view-submissions-btn">
        {{ showSubmissionListForPostId === p._id ? 'Hide Submissions' : 'View All Submissions' }}
      </button>
      
      <!-- Show Submission Form -->
      <app-submission-form
        *ngIf="showSubmissionFormForPostId === p._id"
        [courseId]="courseId"
        [postId]="p._id"
        (submitted)="onSubmissionCompleted()"
        (cancel)="showSubmissionFormForPostId = null"
      >
      </app-submission-form>
      
      <!-- Show Submissions List (displays first + last name) -->
      <div *ngIf="showSubmissionListForPostId === p._id">
        <ng-container *ngIf="submissionsMap[p._id]?.length; else noSubmissions">
          <ul class="submission-list">
            <li *ngFor="let s of submissionsMap[p._id]">
              <strong>Student:</strong> {{ s.first_name }} {{ s.last_name }}
              <br />
              <strong>Submitted At:</strong> {{ s.created_at | date: 'short' }}
              <br />
              <strong>Status:</strong> {{ s.status }}
              <span *ngIf="s.grade !== null">| <strong>Grade:</strong> {{ s.grade }}</span>
              <br />
              <em *ngIf="s.comment">‚Äú{{ s.comment }}‚Äù</em>
            </li>
          </ul>
        </ng-container>
        <ng-template #noSubmissions>
          <p>No submissions yet.</p>
        </ng-template>
      </div>
    </div>

    <hr />
  </li>
</ul>
