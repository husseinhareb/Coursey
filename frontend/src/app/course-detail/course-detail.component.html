<div *ngIf="loadingCourse" class="loading">Loading courseâ€¦</div>
<div *ngIf="courseError" class="error">{{ courseError }}</div>

<div *ngIf="course">
  <h2>{{ course.title }}</h2>
  <p>{{ course.description }}</p>
</div>

<hr />

<button (click)="toggleForm()">
  {{ editing ? 'Edit Post' : '+ Add Post' }}
</button>

<div *ngIf="showForm" class="post-form">
  <form [formGroup]="postForm" (ngSubmit)="savePost()">
    <div>
      <label for="title">Title:</label>
      <input
        id="title"
        formControlName="title"
        placeholder="Title"
      />
      <div
        *ngIf="postForm.get('title')?.touched && postForm.get('title')?.invalid"
        class="error"
      >
        Title is required.
      </div>
    </div>

    <div>
      <label for="content">Content:</label>
      <textarea
        id="content"
        formControlName="content"
        placeholder="Content"
      ></textarea>
      <div
        *ngIf="postForm.get('content')?.touched && postForm.get('content')?.invalid"
        class="error"
      >
        Content is required.
      </div>
    </div>

    <div>
      <label for="type">Type:</label>
      <select id="type" formControlName="type">
        <option value="">-- Select type --</option>
        <option value="lecture">Lecture</option>
        <option value="reminder">Reminder</option>
        <option value="homework">Homework</option>
      </select>
      <div
        *ngIf="postForm.get('type')?.touched && postForm.get('type')?.invalid"
        class="error"
      >
        Type is required.
      </div>
    </div>

    <!-- Attach file if Lecture or Homework -->
    <div
      *ngIf="
        postForm.get('type')?.value === 'lecture' ||
        postForm.get('type')?.value === 'homework'
      "
    >
      <label for="file">Attach File (optional):</label>
      <input
        id="file"
        type="file"
        (change)="onFileSelected($event)"
        accept="*/*"
      />
    </div>

    <!-- Only show due_date if this is a Homework-type post -->
    <div *ngIf="postForm.get('type')?.value === 'homework'">
      <label for="due">Due Date:</label>
      <input
        id="due"
        type="datetime-local"
        formControlName="due_date"
      />
      <div
        *ngIf="
          postForm.get('due_date')?.touched &&
          postForm.get('due_date')?.invalid
        "
        class="error"
      >
        Due date is required for homework.
      </div>
    </div>

    <div class="form-buttons">
      <button type="submit" [disabled]="postForm.invalid">
        {{ editing ? 'Update' : 'Create' }}
      </button>
      <button type="button" (click)="toggleForm()">Cancel</button>
    </div>
  </form>
</div>

<hr />

<div *ngIf="loadingPosts" class="loading">Loading postsâ€¦</div>
<div *ngIf="postsError" class="error">{{ postsError }}</div>

<ul *ngIf="!loadingPosts && !postsError" class="posts-list">
  <li *ngFor="let p of posts" class="post-item">
    <h3>
      {{ p.ispinned ? 'ðŸ“Œ ' : '' }}{{ p.title }}
      <span *ngIf="p.type === 'homework'" style="color: green;">(HW)</span>
    </h3>
    <p>{{ p.content }}</p>
    <small>Type: {{ p.type }}</small><br />
    <small>Position: {{ p.position }}</small><br />
    <small *ngIf="p.ispinned">
      Pinned At: {{ p.pinnedAt | date: 'short' }}
    </small><br />

    <!-- If this is a Homework post, show the due_date -->
    <div *ngIf="p.type === 'homework'">
      <small>Due Date: {{ p.due_date | date: 'short' }}</small><br />
    </div>

    <!-- Pin / Unpin Button -->
    <button (click)="togglePin(p)">
      {{ p.ispinned ? 'Unpin' : 'Pin' }}
    </button>

    <!-- â–² / â–¼ arrows for non-pinned posts only -->
    <button
      *ngIf="!p.ispinned"
      (click)="moveUp(p)"
      [disabled]="p.position === 1"
      title="Move up"
    >
      â–²
    </button>
    <button
      *ngIf="!p.ispinned"
      (click)="moveDown(p)"
      [disabled]="p.position === unpinnedCount"
      title="Move down"
    >
      â–¼
    </button>

    <!-- Edit / Delete Buttons -->
    <button (click)="toggleForm(p)">Edit</button>
    <button (click)="deletePost(p)">Delete</button>

    <!-- HOMEWORKâ€SPECIFIC ACTIONS -->
    <div *ngIf="p.type === 'homework'" class="homework-actions">
      <br />
      <strong>Homework Actions:</strong><br />

      <!-- 1) Student: toggle â€œSubmit Homeworkâ€ -->
      <button (click)="toggleSubmissionForm(p._id)" class="submit-btn">
        {{
          showSubmissionFormForPostId === p._id
            ? 'Cancel Submit'
            : 'Submit Homework'
        }}
      </button>

      <!-- 2) Teacher/Admin: toggle â€œView All Submissionsâ€ -->
      <button (click)="toggleSubmissionList(p._id)" class="view-submissions-btn">
        {{
          showSubmissionListForPostId === p._id
            ? 'Hide Submissions'
            : 'View All Submissions'
        }}
      </button>

      <!-- 3) Show Submission Form (for students) -->
      <div *ngIf="showSubmissionFormForPostId === p._id">
        <app-submission-form
          [courseId]="courseId"
          [postId]="p._id"
          (submitted)="onSubmissionCompleted()"
          (cancel)="showSubmissionFormForPostId = null"
        ></app-submission-form>
      </div>

      <!-- 4) Show Submission List (for teachers) -->
      <div
        *ngIf="showSubmissionListForPostId === p._id"
        class="submissions-container"
      >
        <app-submission-list
          [courseId]="courseId"
          [postId]="p._id"
        ></app-submission-list>
      </div>
    </div>

    <hr />
  </li>
</ul>

<div *ngIf="!loadingPosts && posts?.length === 0">
  <p>No posts available.</p>
</div>
