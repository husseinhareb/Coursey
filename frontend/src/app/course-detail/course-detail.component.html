<!-- src/app/course-detail/course-detail.component.html -->

<!-- 1) Course Info -->
<div *ngIf="loadingCourse">Loading course…</div>
<div *ngIf="courseError" class="error">{{ courseError }}</div>

<div *ngIf="course">
  <h2>{{ course.title }}</h2>
  <p>{{ course.description }}</p>
</div>

<hr />

<!-- 2) Add / Edit Post Toggle -->
<button (click)="toggleForm()">
  {{ editing ? 'Edit Post' : '+ Add Post' }}
</button>

<!-- 3) Create / Update Post Form -->
<div *ngIf="showForm" class="post-form">
  <form [formGroup]="postForm" (ngSubmit)="savePost()">
    <div>
      <label>Title:</label>
      <input formControlName="title" placeholder="Title" />
    </div>
    <div>
      <label>Content:</label>
      <textarea formControlName="content" placeholder="Content"></textarea>
    </div>
    <div>
      <label>Type:</label>
      <select formControlName="type">
        <option value="lecture">Lecture</option>
        <option value="reminder">Reminder</option>
      </select>
    </div>
    <div>
      <label>File ID (optional):</label>
      <input formControlName="fileId" placeholder="File ID (optional)" />
    </div>
    <div>
      <button type="submit" [disabled]="postForm.invalid">
        {{ editing ? 'Update' : 'Create' }}
      </button>
      <button type="button" (click)="toggleForm()">Cancel</button>
    </div>
  </form>
</div>

<hr />

<!-- 4) Posts List -->
<div *ngIf="loadingPosts">Loading posts…</div>
<div *ngIf="postsError" class="error">{{ postsError }}</div>

<ul *ngIf="!loadingPosts && !postsError" class="posts-list">
  <li *ngFor="let p of posts" class="post-item">
    <h3>
      {{ p.ispinned ? '📌 ' : '' }}{{ p.title }}
    </h3>
    <p>{{ p.content }}</p>
    <small>Type: {{ p.type }}</small><br />
    <small>Position: {{ p.position }}</small><br/>
    <small *ngIf="p.ispinned">
      Pinned At: {{ p.pinnedAt | date:'short' }}
    </small>
    <br/>

    <!-- 4a) Pin / Unpin -->
    <button (click)="togglePin(p)">
      {{ p.ispinned ? 'Unpin' : 'Pin' }}
    </button>

    <!-- 4b) ▲ / ▼ (only for unpinned posts) -->
    <button
      *ngIf="!p.ispinned"
      (click)="moveUp(p)"
      [disabled]="p.position === 1"
      title="Move up"
    >▲</button>
    <button
      *ngIf="!p.ispinned"
      (click)="moveDown(p)"
      [disabled]="p.position === unpinnedCount"
      title="Move down"
    >▼</button>

    <!-- 4c) Edit / Delete -->
    <button (click)="toggleForm(p)">Edit</button>
    <button (click)="deletePost(p)">Delete</button>

    <hr />

    <!-- 5) “Submit Homework” button -->
    <button (click)="toggleSubmissionForm(p)">
      {{ showSubmissionFormForPostId === p._id ? 'Cancel Submit' : 'Submit Homework' }}
    </button>

    <!-- 5a) Render the SubmissionFormComponent when toggled -->
    <app-submission-form
      *ngIf="showSubmissionFormForPostId === p._id"
      [courseId]="courseId"
      [postId]="p._id"
      (submitted)="loadPosts()"
      (cancel)="toggleSubmissionForm(p)">
    </app-submission-form>

    <!-- 6) “View Submissions” button -->
    <button (click)="toggleSubmissionList(p)">
      {{ showSubmissionListForPostId === p._id ? 'Hide Submissions' : 'View Submissions' }}
    </button>

    <!-- 6a) Render the SubmissionListComponent when toggled -->
    <app-submission-list
      *ngIf="showSubmissionListForPostId === p._id"
      [courseId]="courseId"
      [postId]="p._id">
    </app-submission-list>

    <hr />
  </li>
</ul>
