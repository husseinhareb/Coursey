<div class="submission-list">
    <!-- Title adapts to role -->
    <h4 *ngIf="canViewAll">Toutes les soumissions</h4>
    <h4 *ngIf="!canViewAll">Vos soumissions</h4>

    <div *ngIf="loading">Chargement des soumissions…</div>
    <div *ngIf="error" class="error">{{ error }}</div>

    <table *ngIf="!loading && !error" border="1" cellpadding="4" cellspacing="0">
        <thead>
            <tr>
                <!-- Only professors/admins see the student column -->
                <th *ngIf="canViewAll">Étudiant·e</th>
                <th>Fichier</th>
                <th>Soumis le</th>
                <th>Due Date</th>
                <th>Statut</th>
                <th>Note</th>
                <th>Commentaire</th>
                <!-- Only professors/admins can grade -->
                <th *ngIf="canGrade">Actions</th>
            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let s of displayedSubmissions">
                <td *ngIf="canViewAll">
                    {{ s.firstName || '—' }} {{ s.lastName || '' }}
                </td>
                <td>
                    <ng-container *ngIf="s.file_name && s.file_id; else noFile">
                        <a [href]="getFileUrl(s.file_id)" target="_blank" rel="noopener">
                            {{ s.file_name }}
                        </a>
                    </ng-container>
                    <ng-template #noFile>—</ng-template>
                </td>
                <td>{{ s.created_at | date: 'short' }}</td>
                <td>
                    <ng-container *ngIf="postDueDate; else noDue">
                        {{ postDueDate | date: 'short' }}
                    </ng-container>
                    <ng-template #noDue>—</ng-template>
                </td>
                <td>
                    <span [ngClass]="{
                  'badge-submitted': s.status === 'submitted',
                  'badge-late': s.status === 'late',
                  'badge-graded': s.status === 'graded'
                }">
                        {{ formatStatus(s.status) }}
                    </span>
                </td>
                <td>{{ s.grade != null ? s.grade : '—' }}</td>
                <td>{{ s.comment != null ? s.comment : '—' }}</td>
                <td *ngIf="canGrade">
                    <button *ngIf="s.status !== 'graded'" (click)="startGrading(s._id)">
                        Noter
                    </button>
                </td>
            </tr>

            <!-- “No submissions” row (with proper interpolation inside <td>) -->
            <tr *ngIf="displayedSubmissions.length === 0">
                <td [attr.colspan]="canViewAll ? 8 : 7">
                    {{
                    canViewAll
                    ? 'Aucune soumission pour le moment.'
                    : 'Vous n\'avez pas encore soumis.'
                    }}
                </td>
            </tr>

        </tbody>
    </table>

    <!-- Grading Form (only visible to prof/admin) -->
    <div *ngIf="gradingSubmissionId && canGrade" class="grading-form">
        <h5>Noter la soumission</h5>
        <form [formGroup]="gradeForm" (ngSubmit)="submitGrade()">
            <div>
                <label for="grade">Note (0–100) :</label>
                <input id="grade" type="number" formControlName="grade" placeholder="par ex. 85" />
                <div *ngIf="
                gradeForm.get('grade')?.touched &&
                gradeForm.get('grade')?.invalid
              " class="error">
                    La note doit être entre 0 et 100.
                </div>
            </div>
            <div>
                <label for="comment">Commentaire :</label>
                <textarea id="comment" formControlName="comment" placeholder="Vos commentaires…"></textarea>
                <div *ngIf="
                gradeForm.get('comment')?.touched &&
                gradeForm.get('comment')?.invalid
              " class="error">
                    Un commentaire est requis.
                </div>
            </div>
            <button type="submit" [disabled]="gradeForm.invalid || gradingLoading">
                {{ gradingLoading ? 'Enregistrement…' : 'Enregistrer la note' }}
            </button>
            <button type="button" (click)="cancelGrading()">Annuler</button>
        </form>
        <div *ngIf="gradingError" class="error">{{ gradingError }}</div>
    </div>
</div>